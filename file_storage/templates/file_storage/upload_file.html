{% extends 'base.html' %}
{% load static %}

{% block title %}Загрузка файла - {{ block.super }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <h2 class="mb-4 text-center">Загрузка нового файла</h2>

        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    <p class="mb-0">{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            {# --- Зона для КЛИКА и отображения ИМЕНИ файла --- #}
            <div class="mb-3">
                {# Теперь LABEL имеет ID и стили click-zone #}
                <label id="click-zone" for="{{ form.file.id_for_label }}">
                    <p id="click-zone-text">Щёлкните здесь или перетащите файл в любое место окна</p>
                </label>

                {# Само поле ввода файла (скрыто через CSS). Помещаем ПОСЛЕ label #}
                {{ form.file }}

                 {# Вывод ошибок поля #}
                {% if form.file.errors %}
                    <div class="invalid-feedback d-block mt-2">
                        {% for error in form.file.errors %}
                            <span>{{ error }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
                 {# Вывод текста помощи для поля, если он есть #}
                {% if form.file.help_text %}
                    <small class="form-text text-muted d-block mt-1">{{ form.file.help_text }}</small>
                {% endif %}
            </div>
            {# --- Конец зоны для клика --- #}


            <div class="d-grid gap-2 mt-4">
                 <button type="submit" class="btn btn-primary btn-lg">Загрузить</button>
            </div>

        </form>

        <div class="mt-4 text-center">
             <a href="{% url 'file_storage:list_files' %}" class="btn btn-secondary">К списку файлов</a>
        </div>

    </div>
</div>

{# --- Полноэкранный оверлей (без изменений) --- #}
<div id="fullscreen-drop-overlay">
    <p>Бросайте файл сюда!</p>
</div>


{# --- JavaScript (практически без изменений) --- #}
<script>
    document.addEventListener('DOMContentLoaded', () => {

        // Теперь clickZone - это сам label
        const clickZone = document.getElementById('click-zone');
        const fileInput = document.getElementById('{{ form.file.id_for_label }}');
        // Текст ищем внутри clickZone (label)
        const clickZoneText = clickZone.querySelector('#click-zone-text');
        const overlay = document.getElementById('fullscreen-drop-overlay');

        // Проверка на существование элементов (clickZoneText теперь ищется внутри clickZone)
        if (!clickZone || !fileInput || !clickZoneText || !overlay) {
            console.error("Не найдены необходимые элементы DOM");
            if (!clickZone) console.error("clickZone не найден");
            if (!fileInput) console.error("fileInput не найден");
            if (!clickZoneText) console.error("clickZoneText не найден");
            if (!overlay) console.error("overlay не найден");
            return;
        }

        // --- Обновление интерфейса при выборе файла ---
        function updateUIWithFileName(files) {
            if (files && files.length > 0) {
                 clickZoneText.textContent = `Выбран файл: ${files[0].name}`;
                 clickZone.classList.add('file-selected');
            } else {
                 clickZoneText.textContent = 'Щёлкните здесь или перетащите файл в любое место окна';
                 clickZone.classList.remove('file-selected');
            }
        }

        // --- Обработка выбора файла через стандартный диалог (клик по label) ---
        // Теперь клик по label напрямую работает благодаря 'for', доп. обработчик не нужен.
        // Но обработчик change все еще нужен для обновления UI
        fileInput.addEventListener('change', () => {
            updateUIWithFileName(fileInput.files);
        });

        // --- Обработка событий Drag and Drop на ВСЕЙ СТРАНИЦЕ (без изменений) ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        document.body.addEventListener('dragenter', (e) => {
            if (e.dataTransfer.types.includes('Files')) { overlay.classList.add('visible'); }
        }, false);

        overlay.addEventListener('dragleave', (e) => {
            if (e.target === overlay) { overlay.classList.remove('visible'); }
        }, false);

        document.body.addEventListener('drop', (e) => {
            overlay.classList.remove('visible');
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                updateUIWithFileName(files);
            }
        }, false);

        // Этот обработчик все еще полезен, если перетаскивание начнется над зоной
         clickZone.addEventListener('dragenter', (e) => {
              if (e.dataTransfer.types.includes('Files')) {
                 overlay.classList.add('visible');
             }
         }, false);

    });
</script>

{% endblock %}